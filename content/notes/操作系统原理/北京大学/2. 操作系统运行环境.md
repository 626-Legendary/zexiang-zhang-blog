---
title: 2. 操作系统运行环境
date: 2025-12-20
tags: [Operating Systems,学习笔记]
cover: /covers/操作系统原理/北京大学/banner.png
---

# 操作系统运行环境（Lecture 2 笔记）

> 本讲重点：**CPU 状态（用户态 / 内核态）· 中断与异常机制 · 系统调用**

---

## 一、操作系统运行环境概述

### 1. 操作系统的地位
- 操作系统是**硬件之上的第一层扩展**
- 主要职责：
  - 支持程序的**启动、执行、结束**
  - 提供应用程序的**共性服务**（I/O、内存、设备等）
  - 解决**性能、安全、健壮性**问题
- 与普通软件的根本区别：
  - **必须直接和硬件打交道**，依赖硬件体系结构支持

---

## 二、处理器状态（Processor Mode）

### 1. CPU 的基本组成
- 运算器
- 控制器
- 寄存器
- 高速缓存（Cache）

### 2. 寄存器分类

#### （1）用户可见寄存器
- 编译器分配与使用
- 目的：**减少内存访问，提高程序执行效率**
- 对应用程序透明

#### （2）控制与状态寄存器（OS 重点关注）
- 用于**控制处理器行为**
- 只能在**特权级别**下访问

典型寄存器：
- **PC（程序计数器）**：下一条指令地址
- **IR（指令寄存器）**：当前执行的指令
- **PSW（程序状态字）**：
  - CPU 当前状态
  - 条件码
  - 中断允许位
  - 运行模式（用户态 / 内核态）

---

## 三、保护机制与 CPU 特权级

### 1. 为什么需要保护？
- 操作系统特征：**并发 + 共享**
- 保护目标：
  - 用户程序之间互不干扰
  - 用户程序不能破坏操作系统

### 2. CPU 特权级思想
- 不同特权级 → 不同指令集合
- 高特权级 ⊇ 低特权级指令

### 3. x86 特权环（Ring）
- Ring 0（R0）：内核态（操作系统核心代码）
- Ring 1 / Ring 2：中间层（驱动、受保护服务，实际很少用）
- Ring 3（R3）：用户态（用户程序）

👉 **现代 OS（Linux / Windows）只使用 R0 和 R3**

---

## 四、指令分类

### 1. 特权指令（仅内核态可执行）
- 启动 I/O
- 内存清零
- 修改 PSW
- 设置时钟
- 中断控制（开 / 关中断）
- 停机

### 2. 非特权指令（用户态可执行）
- 算术运算
- 控制转移
- 普通取数指令

### 3. 访管指令（陷入指令）【重点】
- 本身是**非特权指令**
- 功能：
  - 使 CPU 从**用户态陷入内核态**
- 本质：
  - 用户访问“管理态（Supervisor Mode）”的唯一合法入口

常见形式：
- `int`
- `trap`
- `syscall`
- `sysenter / sysexit`

---

## 五、中断与异常（Interrupt & Exception）

### 1. 基本概念
- **中断**：外部事件（外中断）
- **异常**：指令执行过程中产生（内中断）
- 二者统称为：**事件**

---

### 2. 中断类型

#### （1）I/O 中断
- 键盘输入（Ctrl+C）
- 网卡收到数据包
- 磁盘读写完成
- 打印机完成任务

#### （2）时钟中断
- 定时器到期
- 时间片用完（进程调度基础）

#### （3）硬件故障中断
- 电池电量过低
- 内存奇偶校验错误

---

### 3. 异常类型

#### （1）系统调用（可编程异常）
- 用户主动触发
- 用于请求 OS 服务

#### （2）缺页异常（Page Fault）
- 访问页面未装入内存

#### （3）保护性异常
- 写只读内存
- 地址越界访问

#### （4）程序性异常
- 除零
- 算术溢出
- 栈溢出

---

## 六、中断向量表（Interrupt Vector Table）

### 1. 基本概念
- 中断向量表：**中断号 → 中断处理程序入口地址**
- 共 **256 个中断向量（0–255）**

### 2. 典型中断向量
- 0：除零异常
- 1：单步调试
- 4：算术溢出
- 13：保护性异常
- 14：缺页异常
- **128：系统调用（Linux 经典方式）**

---

## 七、中断响应全过程（考试重点）

### 1. 硬件完成的工作
1. 保存现场：
   - PC
   - PSW
2. 根据中断号查**中断向量表**
3. 装入中断处理程序入口地址
4. 切换到内核态

### 2. 软件完成的工作（中断处理程序）
- 保存其余寄存器
- 处理中断逻辑（I/O、异常处理）
- 唤醒等待进程 / 启动下一次 I/O
- 可能触发进程调度

### 3. 中断返回
- 执行中断返回指令
- 恢复现场
- 返回被打断程序继续执行

---

## 八、系统调用（System Call）

### 1. 定义
- 系统调用 = 操作系统功能调用
- 用户程序请求 OS 服务的**标准接口**

### 2. 系统调用的作用
- 用户不能直接执行特权指令
- 通过系统调用：
  - 用户态 → 内核态
  - OS 代为完成特权操作

### 3. 系统调用分类
- 进程控制：创建 / 撤销
- 进程通信
- 文件管理：open / read / write / close
- 设备管理
- 信息维护

### 4. 区分概念（常考）
- 系统调用 ≠ 库函数 ≠ API ≠ 内核函数

---

## 九、核心总结（必背版）

- 操作系统依赖硬件提供的**特权级机制**
- 用户态与内核态通过**中断 / 异常 / 系统调用**切换
- 中断向量表是 CPU 进入内核的**统一入口表**
- 系统调用是用户访问 OS 的**唯一合法途径**

---

> 建议复习顺序：
> **CPU 状态 → 特权指令 → 中断/异常 → 中断向量表 → 系统调用**